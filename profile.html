<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AniMy - Profile</title>
<link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16x16.png">
<link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png">
<link rel="manifest" href="img/site.webmanifest">
<link rel="icon" href="img/favicon.ico">
<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poiret+One&display=swap" rel="stylesheet"/>

<style>
:root{
  --bg:#ffffff;
  --text:#090a0c;
  --muted:#6e6e79;
  --card:#f6f7fb;
  --line:rgba(15,17,22,.08);
  --shadow:0 12px 28px rgba(15,17,22,.06);

  --accent:#6c5ce7;
  --accent-2:#a78bfa;
  --accent-3:#22d3ee;
  --danger:#ef4444;

  --ring: rgba(108,92,231,.35);

  /* glass surfaces */
  --surface: rgba(10,12,16,.12);
  --surface-strong: rgba(10,12,16,.18);
  --glass-blur: saturate(140%) blur(10px);
}
body.theme-dark{
  --bg:#000000;
  --text:#f5f7fb;
  --muted:#b7bbca;
  --card:#161923;
  --line:rgba(255,255,255,.08);
  --shadow:0 14px 36px rgba(0,0,0,.35);

  --accent:#a78bfa;
  --accent-2:#c4b5fd;
  --accent-3:#22d3ee;
  --danger:#f87171;

  --ring: rgba(167,139,253,.35);

  --surface: rgba(255,255,255,.08);
  --surface-strong: rgba(255,255,255,.14);
}

*{box-sizing:border-box}
html,body{
  height:100%;margin:0;
  font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif;
  font-size:16px;line-height:1.65;
  background:var(--bg);color:var(--text);
  transition:background .18s,color .18s;
  width:100%;overflow-x:hidden;
  font-weight:400; /* normal */
}
img{max-width:100%;display:block}
button{font-family:inherit}

/*  Top Bar (desktop & tablet)  */
.top-bar{
  position:fixed;top:0;left:0;right:0;
  display:flex;justify-content:space-between;align-items:center;
  padding:10px 18px;gap:12px;background:var(--bg);
  border-bottom:0 !important; 
  z-index:999;
  backdrop-filter:saturate(180%) blur(6px);
}
.left-controls,.right-controls{display:flex;align-items:center;gap:10px;}
.icon-btn{
  background:transparent;border:0;padding:6px;border-radius:10px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:transform .12s, background .12s, box-shadow .12s
}
.icon-btn:active{transform:scale(.96)}
.icon-btn:focus-visible{outline:2px solid var(--ring); outline-offset:2px; border-radius:12px;}
.icon-btn img{width:26px;height:26px;object-fit:contain}
#langSelect{
  background:transparent;border:1px solid var(--line);border-radius:10px;
  color:var(--text);padding:6px 10px;font-size:14px;
  transition:border .18s;
}

/*  Navbar  */
.navbar{
  position:sticky;top:46px;display:flex;align-items:center;justify-content:space-between;
  padding:12px 20px;background:var(--bg);z-index:40;
  border-top:none !important;border-bottom:none !important; 
}
.brand a{display:flex;align-items:center;gap:10px;text-decoration:none}
.nav{display:flex;gap:14px;flex-wrap:wrap;max-width:100%}
.nav-link{
  color:var(--text);text-decoration:none;padding:8px 10px;border-radius:10px;
  font-weight:500;font-size:clamp(12px, 3.3vw, 15px);line-height:1;transition:all .18s;white-space:nowrap
}
.nav-link:hover{color:var(--accent);background:rgba(99,102,241,.10)}
.nav{overflow:hidden}

/*  Desktop/Tablet Search bar (toggle)  */
.search-bar{
  position:fixed;top:64px;left:50%;transform:translateX(-50%);
  width:min(680px,92%);background:var(--surface);
  border:1px solid var(--line);
  border-radius:14px;padding:8px 10px;display:flex;align-items:center;gap:10px;
  box-shadow:var(--shadow);z-index:999;backdrop-filter:var(--glass-blur)
}
.hidden{display:none !important}
.search-input{flex:1;border:none;background:transparent;color:var(--text);font-size:16px;padding:10px 8px}
.search-ico-btn{background:transparent;border:0;cursor:pointer;display:flex;align-items:center;justify-content:center}
.search-ico-btn img{width:22px;height:22px;opacity:.9}

/*  Mobile top search (always visible on mobile)  */
.mobile-search{
  position:sticky;top:0;z-index:998;padding:10px 14px 6px;
  background:linear-gradient(to bottom, var(--bg) 70%, transparent);
  display:none;
}
.mobile-search .search-box{
  display:flex;align-items:center;gap:10px;
  padding:10px 12px;border-radius:14px;border:1px solid var(--line);
  background:var(--surface-strong);backdrop-filter:var(--glass-blur);
}
.mobile-search input{
  flex:1;border:none;background:transparent;color:var(--text);font-size:15px;padding:6px 4px;
}
.mobile-search button{background:transparent;border:0;cursor:pointer}
.mobile-search img{width:22px;height:22px;opacity:.9}

/*  Profile header  */
.profile-header{
  margin-top:110px;position:relative;height:220px;
  background:linear-gradient(135deg,#6c5ce7,#a78bfa);
  border-bottom-left-radius:20px;border-bottom-right-radius:20px;
  transition:background .18s; box-shadow:var(--shadow)
}
.profile-avatar{
  width:120px;height:120px;border-radius:50%;overflow:hidden;border:4px solid var(--bg);
  position:absolute;bottom:-60px;left:50%;transform:translateX(-50%);
  background:#444;cursor:pointer;display:flex;align-items:center;justify-content:center;
  box-shadow:0 10px 28px rgba(0,0,0,.35)
}
.profile-avatar img{width:100%;height:100%;object-fit:cover}
.profile-info{text-align:center;margin-top:90px}
.profile-info h2{margin:0;font-size:clamp(18px,3.8vw,24px);font-weight:600}
.profile-info p{margin:6px 0 0;color:var(--muted);font-size:14px}
#editProfileBtn{
  margin-top:12px;padding:10px 14px;border-radius:12px;
  border:1px solid var(--line);background:rgba(99,102,241,.10);
  color:var(--text);cursor:pointer;font-weight:600
}

/*  Tabs & Lists  */
.tabs{display:flex;justify-content:center;gap:10px;margin-top:22px;flex-wrap:wrap}
.tab-btn{
  padding:8px 14px;border-radius:12px;border:1px solid var(--line);
  background:transparent;color:var(--text);cursor:pointer;font-size:14px;font-weight:500
}
.tab-btn.active{
  background:linear-gradient(90deg,var(--accent),var(--accent-2));
  color:#0b0b0f;border-color:transparent
}
.list-container{max-width:1040px;margin:20px auto;padding:0 16px}
.actions-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;color:var(--muted);font-weight:500}

/*  Cards Grid  */
.big-grid{
  display:grid;gap:12px;margin-top:16px;margin-bottom:70px;justify-content:center;
  grid-template-columns:repeat(6, minmax(0, 1fr));
}
@media (max-width:1100px){ .big-grid{grid-template-columns:repeat(5,1fr)} }
@media (max-width:920px){ .big-grid{grid-template-columns:repeat(4,1fr)} }
@media (max-width:720px){ .big-grid{grid-template-columns:repeat(3,1fr)} }
@media (max-width:520px){ .big-grid{grid-template-columns:repeat(2,1fr)} }

.big-card{
  position:relative;border-radius:14px;background:transparent;padding:0;text-align:center;
  box-shadow:none;transition:transform .2s, box-shadow .2s;
  overflow:hidden;touch-action:pan-y; user-select:none;
}
.big-card:hover{transform:translateY(-2px)}
.big-card a{text-decoration:none;color:inherit;display:block;position:relative;border-radius:12px;overflow:hidden}
.big-card img{width:100%;height:200px;object-fit:cover;border-radius:12px;display:block;box-shadow:0 12px 30px rgba(0,0,0,.35)}

/*  Swipe UI layer (mobile)  */
.swipe-layer{
  position:absolute;inset:0;pointer-events:none;display:flex;justify-content:space-between;align-items:center;
  padding:0 10px;opacity:0;transition:opacity .12s;
}
.big-card.swiping .swipe-layer{opacity:1}
.swipe-layer .icon-pill{
  display:flex;align-items:center;justify-content:center;
  width:42px;height:42px;border-radius:999px;background:rgba(0,0,0,.35);backdrop-filter:var(--glass-blur);
  border:1px solid var(--line);
}
.swipe-layer .icon-pill img{width:22px;height:22px;filter:drop-shadow(0 2px 6px rgba(0,0,0,.35))}

/* glow while swiping (keep pretty light) */
.big-card.swiping.glow-right{ background:linear-gradient(90deg, rgba(34,211,238,.25), transparent 60%); }
.big-card.swiping.glow-left { background:linear-gradient(90deg, transparent 40%, rgba(239,68,68,.25)); }

/*  Desktop action icons (bottom corners)  */
.desktop-actions{
  position:absolute;left:8px;right:8px;bottom:8px;display:flex;justify-content:space-between;pointer-events:none;
}
.action-btn{
  width:30px;height:30px;border-radius:8px;border:1px solid var(--line);
  background:var(--surface-strong);backdrop-filter:var(--glass-blur);
  display:flex;align-items:center;justify-content:center;cursor:pointer;pointer-events:auto;
  transition:transform .12s, background .12s;
}
.action-btn:hover{transform:scale(1.06); background:var(--surface)}
.action-btn img{width:18px;height:18px;display:block}

/* hide desktop action icons on mobile */
@media (max-width: 768px){
  .desktop-actions{ display:none; }
}

/*  Modal  */
.edit-modal{position:fixed;inset:0;background:rgba(0,0,0,0.55);display:flex;align-items:center;justify-content:center;z-index:2000;opacity:0;visibility:hidden;transition:.25s ease;backdrop-filter:blur(6px);}
.edit-modal.active{opacity:1;visibility:visible;}
.edit-box{background:var(--card);width:min(520px,92%);border-radius:16px;padding:20px;box-shadow:var(--shadow);color:var(--text);animation:pop .25s ease;border:1px solid var(--line)}
@keyframes pop{from{transform:scale(.97);opacity:0;}to{transform:scale(1);opacity:1;}}
.edit-box h3{text-align:center;color:var(--accent);margin-top:0;font-family:"Poiret One",cursive;font-size:22px}
.avatar-preview{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.avatar-preview img{width:64px;height:64px;border-radius:50%;border:2px solid var(--accent);object-fit:cover}
.avatar-preview button{padding:8px 12px;border:none;background:var(--accent);color:#0b0b0f;border-radius:10px;cursor:pointer;font-weight:700}
.edit-box label{display:block;margin-top:10px;font-weight:600;}
.edit-box input[type=text],.edit-box input[type=password],.edit-box textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:transparent;color:var(--text);resize:none;}
.edit-box input[type=color]{width:100%;height:42px;border:none;border-radius:8px;cursor:pointer;margin-top:6px;}
.edit-actions{display:flex;flex-direction:column;gap:8px;margin-top:14px;}
.edit-actions button{padding:10px;border:none;border-radius:12px;cursor:pointer;font-weight:700;}
.saveBtn{background:var(--accent);color:#0b0b0f;}
.logoutBtn{background:var(--danger);color:#fff;}
.switchBtn{background:#2b2f3d;color:#fff;}
.closeBtn{background:#bdbdcc;color:#111;}

/* Provider buttons */
.provider-btn{display:flex;align-items:center;gap:10px;justify-content:center;width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);background:var(--bg);color:var(--text);cursor:pointer;font-weight:700;}
.provider-btn svg{width:18px;height:18px}
.provider-group{display:flex;flex-direction:column;gap:8px;margin-top:10px}

/*  Gradient presets  */
.preset-wrap{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-top:8px}
.preset{
  height:34px;border-radius:10px;border:1px solid var(--line);cursor:pointer;position:relative;overflow:hidden
}
.preset:after{content:"";position:absolute;inset:0;box-shadow:inset 0 0 0 0 rgba(255,255,255,.0);transition:box-shadow .18s}
.preset:focus-visible{outline:2px solid var(--ring);outline-offset:2px}
.preset.active:after{box-shadow:inset 0 0 0 2px #fff}

/*  Bottom bar (mobile)  */
.mobile-bottom{
  position:fixed;left:0;right:0;bottom:0;padding:8px 14px 10px;z-index:999;
  display:none;
}
.mobile-bottom .bar{
  display:flex;align-items:center;justify-content:space-around;
  border:1px solid var(--line);border-radius:16px;background:var(--surface-strong);
  backdrop-filter:var(--glass-blur);padding:10px;
}
.mobile-bottom .bar button{
  background:transparent;border:0;cursor:pointer;width:36px;height:36px;border-radius:10px;
  display:flex;align-items:center;justify-content:center;
}
.mobile-bottom .bar img{width:22px;height:22px;border-radius:6px;object-fit:cover}

/*  Responsive rules  */
@media (max-width: 768px){
  .top-bar .left-controls,
  .top-bar .right-controls{ display:none; }
  .mobile-search{ display:block; }
  .mobile-bottom{ display:block; }
  .navbar{ top:0; }
}
@media (max-width: 420px){
  .tabs{gap:8px}
  .tab-btn{font-size:12px;padding:7px 10px}
}

.options-btn, .options-menu { display:none !important; }

html, body, .top-bar, .navbar, .mobile-search { 
  background: var(--bg) !important;
}
/*  Round avatar with glow (same as saved.html)*/
.avatar-circle-glow{
  width:36px;height:36px;border-radius:999px;overflow:hidden;position:relative;
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 0 0 2px rgba(167,139,253,.55), 0 0 12px 3px rgba(167,139,253,.25);
}
.avatar-circle-glow img{
  width:100%;height:100%;object-fit:cover;border-radius:999px;display:block;
}
</style>
</head>
<body class="theme-dark profile-page">

<!-- Top bar -->
<div class="top-bar">
  <div class="left-controls">
    <button id="themeToggle" class="icon-btn" title="Toggle theme">
      <img id="themeIcon" src="img/light.png" alt="theme">
    </button>
    <select id="langSelect">
      <option value="en">EN</option><option value="ua">UA</option><option value="de">DE</option>
    </select>
  </div>
  <div class="right-controls">
    <button class="icon-btn" id="searchBtn" aria-label="Search">
      <img id="searchBtnIcon" src="img/search-icon-white.png" alt="search">
    </button>
    <button class="icon-btn" id="savedBtn" aria-label="Saved">
      <img id="savedIcon" src="img/bookmark_white.png" alt="saved">
    </button>
    <a id="topAvatarBtn" class="icon-btn" href="profile.html" aria-label="Profile">
  <span class="avatar-circle-glow">
    <img id="topAvatarImg" src="img/user-profile.png" alt="avatar">
  </span>
</a>
  </div>
</div>

<!-- Navbar -->
<header class="navbar">
  <div class="brand">
    <a href="index.html">
      <img id="logoImg" src="img/animy_white.png" style="height:42px;" alt="AniMy">
    </a>
  </div>
  <nav class="nav">
    <a href="index.html" class="nav-link" data-i18n="home">Home</a>
    <a href="movie.html" class="nav-link" data-i18n="movies">Movies</a>
    <a href="anime.html" class="nav-link" data-i18n="anime">Anime</a>
    <a href="trends.html" class="nav-link" data-i18n="trends">Trends</a>
  </nav>
</header>

<!-- Mobile top search -->
<div class="mobile-search">
  <div class="search-box">
    <input id="mSearchInput" type="text" placeholder="Search anime..." />
    <button id="mSearchGo" aria-label="Search">
      <img id="mSearchIcon" src="img/search-icon-white.png" alt="go">
    </button>
  </div>
</div>

<!-- Desktop/Tablet toggled search -->
<div id="searchBar" class="search-bar hidden">
  <input type="text" id="searchInput" class="search-input" placeholder="Search anime..." />
  <button id="searchGo" class="search-ico-btn" aria-label="Search">
    <img id="searchIcon" src="img/search-icon-white.png" alt="search">
  </button>
</div>

<!-- Profile -->
<div class="profile-header" id="profileHeader">
  <div class="profile-avatar" id="avatarBtn"><img id="avatarImg" src="img/user-profile.png" alt="avatar"></div>
</div>

<div class="profile-info">
  <h2 id="userName">Username</h2>
  <p id="userBio">Your bio goes here...</p>
  <button id="editProfileBtn" data-i18n="editProfile">Edit Profile</button>
</div>

<!-- Tabs -->
<div class="tabs">
  <button class="tab-btn active" data-tab="watching" data-i18n="watching">Watching</button>
  <button class="tab-btn" data-tab="liked" data-i18n="liked">Liked</button>
  <button class="tab-btn" data-tab="disliked" data-i18n="disliked">Disliked</button>
</div>

<!-- Lists -->
<div class="list-container">
  <div class="actions-row"><div data-i18n="yourList">Your list</div></div>
  <div id="bigGrid" class="big-grid"></div>
</div>

<!-- Mobile bottom bar -->
<div class="mobile-bottom">
  <div class="bar">
    <button id="mbTheme" title="Theme"><img id="mbThemeIcon" src="img/light.png" alt="theme"></button>
    <button id="mbLang" title="Language"><img id="mbLangIcon" src="img/translation_white.png" alt="lang"></button>
    <button id="mbSaved" title="Saved"><img id="mbSavedIcon" src="img/bookmark_white.png" alt="saved"></button>
    <button id="mbProfile" title="Profile" aria-label="Profile" style="background:transparent;border:0;padding:0;">
  <span class="avatar-circle-glow" style="width:36px;height:36px;">
    <img id="mbAvatarImg" src="img/user-profile.png" alt="avatar">
  </span>
</button>
  </div>
</div>

<input id="avatarFileHidden" type="file" accept="image/*" style="display:none">

<!-- Profile / Login Modal -->
<div class="edit-modal" id="editModal">
  <div class="edit-box">
    <h3 data-i18n="editProfile">Edit Profile</h3>

    <label data-i18n="avatar">Avatar</label>
    <div class="avatar-preview">
      <img id="modalAvatarImg" src="img/user-profile.png" alt="avatar-preview">
      <button id="changeAvatarBtn" data-i18n="change">Change</button>
    </div>
    <input type="file" id="editAvatarFile" accept="image/*" style="display:none">

    <label data-i18n="nickname">Nickname</label>
    <input type="text" id="editName" placeholder="Enter nickname">

    <label data-i18n="bio">Bio</label>
    <textarea id="editBio" rows="3" placeholder="Write something about yourself..."></textarea>

    <label data-i18n="profileBg">Profile background</label>
    <input type="color" id="bgGradient" value="#6c5ce7">
    <div class="preset-wrap" id="presetWrap" aria-label="Gradient presets"></div>

    <!-- LOGIN CHOOSER -->
    <div id="loginChooser" class="provider-group" style="display:none;">
      <button id="googleBtn" class="provider-btn" aria-label="Continue with Google">
        <svg viewBox="0 0 48 48"><path fill="#FFC107" d="M43.6 20.5H42V20H24v8h11.3c-1.7 4.7-6.1 8-11.3 8A12 12 0 1 1 24 12c3 0 5.7 1.1 7.7 3l5.7-5.7C34.5 6.1 29.5 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20c10.4 0 19-7.5 19-20 0-1.3-.1-2.7-.4-3.5z"/><path fill="#FF3D00" d="M6.3 14.7l6.6 4.8C14.9 16 19 12 24 12c3 0 5.7 1.1 7.7 3l5.7-5.7C34.5 6.1 29.5 4 24 4 16.1 4 9.2 8.5 6.3 14.7z"/><path fill="#4CAF50" d="M24 44c5.2 0 10.1-2 13.7-5.3l-6.3-5.3C29.6 35.9 26.9 37 24 37 19 37 14.9 33.9 13 29.3l-6.6 5C9.2 39.5 16.1 44 24 44z"/><path fill="#1976D2" d="M43.6 20.5H42V20H24v8h11.3c-1.3 3.6-4.2 6.4-7.6 7.4l6.3 5.3C36.7 38.9 40 33.3 40 24c0-1.3-.1-2.7-.4-3.5z"/></svg>
        Continue with Google
      </button>
      <button id="appleBtn" class="provider-btn" aria-label="Continue with Apple">
        <svg viewBox="0 0 24 24"><path fill="currentColor" d="M16.365 1.43c0 1.14-.468 2.206-1.266 2.97-.81.777-2.105 1.37-3.196 1.288-.135-1.102.39-2.248 1.17-3.033.81-.824 2.187-1.41 3.292-1.225zm3.86 17.18c-.603 1.4-.884 1.973-1.65 3.187-1.07 1.68-2.58 3.79-4.435 3.8-1.044.01-1.737-.312-2.72-.312-.983 0-1.738.321-2.733.321-1.86.01-3.3-1.82-4.37-3.5-2.386-3.71-4.21-10.49-1.76-15.08 1.225-2.295 3.41-3.77 5.8-3.78 1.08-.02 2.1.36 2.873.36.774 0 2.04-.443 3.455-.377 1.178.048 2.252.416 3.13 1.103-2.75 1.563-2.31 5.64.43 6.96-.48 1.26-.973 2.53-1.123 2.997-.248.77-.15 1.47.155 2.32z"/></svg>
        Continue with Apple
      </button>
      <button id="emailBtn" class="provider-btn" aria-label="Continue with Email">Continue with Email</button>
    </div>

    <!-- EMAIL FORM -->
    <div id="loginSection" style="display:none; margin-top:10px;">
      <label>Login</label>
      <input type="text" id="loginName" placeholder="Email" style="margin-top:6px;">
      <input type="password" id="loginPass" placeholder="Password" style="margin-top:8px;">
      <div style="display:flex;gap:8px;margin-top:10px;">
        <button id="doLoginBtn" class="saveBtn" style="flex:1;">Sign in</button>
        <button id="backToChooser" class="closeBtn" style="flex:1;">Back</button>
      </div>
      <small style="display:block;margin-top:6px;color:var(--muted)">If user not found — we’ll create an account automatically.</small>
    </div>

    <div class="edit-actions">
      <button class="saveBtn" id="saveProfileBtn" data-i18n="saveChanges">Save Changes</button>
      <button id="loginBtn" class="saveBtn" data-i18n="login">Login</button>
      <button class="logoutBtn" id="logoutBtn" data-i18n="logOut">Log Out</button>
      <button class="switchBtn" id="switchAccountBtn" data-i18n="switchAccount">Switch Account</button>
      <button class="closeBtn" id="closeEdit" data-i18n="close">Close</button>
    </div>
  </div>
</div>

<!-- Firebase + App -->
<script type="module">
/*  Firebase Imports  */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut,
  signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { 
  getFirestore, doc, getDoc, setDoc 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/*  Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyB7wYyFG1KNlVl8bW-3pn0U5fgHXktCGic",
  authDomain: "animy-ae6fa.firebaseapp.com",
  projectId: "animy-ae6fa",
  storageBucket: "animy-ae6fa.firebasestorage.app",
  messagingSenderId: "795248580471",
  appId: "1:795248580471:web:c821c22700a045bbb53372",
  measurementId: "G-TFM93P4HRE"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/*  Translations + Icons  */
const translations = {
  en:{home:"Home",movies:"Movies",anime:"Anime",trends:"Trends",watching:"Watching",liked:"Liked",disliked:"Disliked",list:"Add to list",remove:"Remove from list",editProfile:"Edit Profile",avatar:"Avatar",change:"Change",nickname:"Nickname",bio:"Bio",profileBg:"Profile background",saveChanges:"Save Changes",logOut:"Log Out",switchAccount:"Switch Account",close:"Close",yourList:"Your list",selectAnime:"Select Anime",login:"Login"},
  ua:{home:"Головна",movies:"Фільми",anime:"Аніме",trends:"Тренди",watching:"Дивлюся",liked:"Сподобалося",disliked:"Не сподобалося",list:"Додати до списку",remove:"Видалити зі списку",editProfile:"Редагувати профіль",avatar:"Аватар",change:"Змінити",nickname:"Нікнейм",bio:"Біографія",profileBg:"Фон профілю",saveChanges:"Зберегти зміни",logOut:"Вийти",switchAccount:"Змінити акаунт",close:"Закрити",yourList:"Ваш список",selectAnime:"Виберіть Аніме",login:"Увійти"},
  de:{home:"Startseite",movies:"Filme",anime:"Anime",trends:"Trends",watching:"Schaue gerade",liked:"Gefällt",disliked:"Gefällt nicht",list:"Zur Liste hinzufügen",remove:"Von Liste entfernen",editProfile:"Profil bearbeiten",avatar:"Avatar",change:"Ändern",nickname:"Spitzname",bio:"Bio",profileBg:"Profilhintergrund",saveChanges:"Änderungen speichern",logOut:"Abmelden",switchAccount:"Konto wechseln",close:"Schließen",yourList:"Ihre Liste",selectAnime:"Wähle Anime",login:"Anmelden"}
};

/* theme-aware icon sets */
const ICONS = {
  dark: {
    theme: 'img/moon.png',
    search: 'img/search-icon-white.png',
    saved: 'img/bookmark_white.png',
    profile: 'img/user-profile_white.png',
    translation: 'img/translation_white.png',
    remove: 'img/remove_white.png',
    move: 'img/move_white.png',
  },
  light: {
    theme: 'img/light.png',
    search: 'img/search-icon.png',
    saved: 'img/bookmark.png',
    profile: 'img/user-profile.png',
    translation: 'img/translation.png',
    remove: 'img/remove.png',
    move: 'img/move.png',
  }
};

const logoWhite='img/animy_white.png', logoDark='img/animy.png';

/*  DOM  */
const profileHeader=document.getElementById("profileHeader");
const userNameEl=document.getElementById("userName");
const userBioEl=document.getElementById("userBio");
const avatarImg=document.getElementById("avatarImg");
const avatarBtn=document.getElementById("avatarBtn");
const avatarPreview=document.getElementById("modalAvatarImg");
const avatarFile=document.getElementById("editAvatarFile");
const editModal=document.getElementById("editModal");
const bigGridEl=document.getElementById("bigGrid");
const editProfileOpenBtn=document.getElementById("editProfileBtn");
const themeToggleBtn=document.getElementById("themeToggle");
const langSelect=document.getElementById("langSelect");

/* topbar icons */
const themeIconEl=document.getElementById("themeIcon");
const savedIconEl=document.getElementById("savedIcon");
const profileIconEl=document.getElementById("profileIcon");
const searchBtnIcon=document.getElementById("searchBtnIcon");
const logoImg=document.getElementById("logoImg");

/* desktop search bar */
const searchBar=document.getElementById("searchBar");
const searchInput=document.getElementById("searchInput");
const searchGo=document.getElementById("searchGo");
const searchIcon=document.getElementById("searchIcon");

/* mobile search */
const mSearchInput = document.getElementById('mSearchInput');
const mSearchGo = document.getElementById('mSearchGo');
const mSearchIcon = document.getElementById('mSearchIcon');

/* mobile bottom */
const mbTheme=document.getElementById('mbTheme');
const mbThemeIcon=document.getElementById('mbThemeIcon');
const mbLang=document.getElementById('mbLang');
const mbLangIcon=document.getElementById('mbLangIcon');
const mbSaved=document.getElementById('mbSaved');
const mbSavedIcon=document.getElementById('mbSavedIcon');
const mbProfile=document.getElementById('mbProfile');
const mbProfileIcon=document.getElementById('mbProfileIcon');

/* buttons */
const loginBtn=document.getElementById("loginBtn");
const logoutBtn=document.getElementById("logoutBtn");
const switchAccountBtn=document.getElementById("switchAccountBtn");
const saveProfileBtn=document.getElementById("saveProfileBtn");
const loginChooser=document.getElementById("loginChooser");
const loginSection=document.getElementById("loginSection");
const doLoginBtn=document.getElementById("doLoginBtn");
const backToChooser=document.getElementById("backToChooser");
const googleBtn=document.getElementById("googleBtn");
const appleBtn=document.getElementById("appleBtn");
const emailBtn=document.getElementById("emailBtn");

/*  Query helpers  */
function getUidFromQuery(){
  const p = new URLSearchParams(location.search);
  return (p.get('uid')||'').trim();
}

/*  Local cache  */
let profileData=JSON.parse(localStorage.getItem("profileData")||"{}");
let animeData=JSON.parse(localStorage.getItem("animeData")||"{}");
if(!animeData.watching) animeData={watching:[],liked:[],disliked:[]};

/*  Catalog  */
const SITE_CATALOG={
  "Attack on Titan":{file:"new1",link:"attack-on-titan.html",titles:{en:"Attack on Titan",ua:"Атака Титанів",de:"Attack on Titan"}},
  "Bleach":{file:"anime8",link:"bleach.html",titles:{en:"Bleach",ua:"Бліч",de:"Bleach"}},
  "Dandadan":{file:"anime4",link:"dandadan.html",titles:{en:"Dandadan",ua:"Дандадан",de:"Dandadan"}},
  "Evangelion":{file:"new5",link:"evangelion.html",titles:{en:"Evangelion",ua:"Євангеліон",de:"Evangelion"}},
  "Gachiakuta":{file:"anime7",link:"gachiakuta.html",titles:{en:"Gachiakuta",ua:"Гатіакута",de:"Gachiakuta"}},
  "Haikyu":{file:"new7",link:"haikyu.html",titles:{en:"Haikyu",ua:"Волейбол!!",de:"Haikyu"}},
  "Hanako Kun":{file:"new2",link:"hanako-kun.html",titles:{en:"Hanako Kun",ua:"Ханако-кун",de:"Hanako-kun"}},
  "Idol":{file:"new8",link:"idol.html",titles:{en:"Idol",ua:"Айдол",de:"Idol"}},
  "Jujutsu Kaisen":{file:"anime2",link:"jujutsu-kaisen.html",titles:{en:"Jujutsu Kaisen",ua:"Магічна Битва",de:"Jujutsu Kaisen"}},
  "Kaiju No8":{file:"anime5",link:"kaiju-no-8.html",titles:{en:"Kaiju No8",ua:"Кайдзю №8",de:"Kaiju No. 8"}},
  "Kimetsu no yaiba":{file:"anime6",link:"kimetsu-no-yaiba.html",titles:{en:"Demon Slayer",ua:"Клинок, що винищує демонів",de:"Demon Slayer"}},
  "One Piece":{file:"anime1",link:"one-piece.html",titles:{en:"One Piece",ua:"Ван-Піс",de:"One Piece"}},
  "Silent Voice":{file:"new4",link:"silent-voice.html",titles:{en:"A Silent Voice",ua:"Форма голосу",de:"A Silent Voice"}},
  "Spirited Away":{file:"new6",link:"spirited-away.html",titles:{en:"Spirited Away",ua:"Віднесені привидами",de:"Chihiros Reise ins Zauberland"}},
  "The Fragrant Flower":{file:"anime3",link:"the-fragrant-flower.html",titles:{en:"The Fragrant Flower",ua:"Ароматна Квітка",de:"The Fragrant Flower"}},
  "Your Name":{file:"new3",link:"your-name.html",titles:{en:"Your Name",ua:"Твоє ім'я",de:"Your Name"}}
};

/*  Theme helpers  */
function currentTheme(){
  return document.body.classList.contains('theme-dark') ? 'dark' : 'light';
}
function isDefaultAvatar(src){
  if (!src) return true;
  try {
    const path = (new URL(src, location.href)).pathname; // только путь
    return /\/img\/user-profile(_white)?\.png$/i.test(path);
  } catch {
    return /img\/user-profile(_white)?\.png$/i.test(src);
  }
}



function applyTheme(theme){
  const body=document.body;
  body.classList.remove("theme-dark","theme-light");
  body.classList.add("theme-"+theme);
  localStorage.setItem("theme",theme);

  const isDark = theme === "dark";

  
  if (themeIconEl)  themeIconEl.src  = isDark ? "img/light.png" : "img/moon.png";     
  if (savedIconEl)  savedIconEl.src  = isDark ? ICONS.dark.saved : ICONS.light.saved;
  if (searchBtnIcon) searchBtnIcon.src = isDark ? ICONS.dark.search : ICONS.light.search;
  if (searchIcon)   searchIcon.src   = isDark ? ICONS.dark.search : ICONS.light.search;
  if (mSearchIcon)  mSearchIcon.src  = isDark ? ICONS.dark.search : ICONS.light.search;
  if (logoImg)      logoImg.src      = isDark ? logoWhite : logoDark;

 
  if (mbThemeIcon)  mbThemeIcon.src  = isDark ? "img/light.png" : "img/moon.png";     
  if (mbSavedIcon)  mbSavedIcon.src  = isDark ? ICONS.dark.saved : ICONS.light.saved;
  if (mbLangIcon)   mbLangIcon.src   = isDark ? ICONS.dark.translation : ICONS.light.translation;

  updateProfileIcons();

  refreshActionIcons();
}

/*  Read-only mode for viewing other user's profile  */
let READ_ONLY_MODE = false;

function setReadOnlyProfile(on){
  READ_ONLY_MODE = !!on;
  const hide = (el)=>{ if(el) el.style.display = 'none'; };

  hide(document.getElementById('editProfileBtn'));
  hide(document.getElementById('loginBtn'));
  hide(document.getElementById('logoutBtn'));
  hide(document.getElementById('switchAccountBtn'));
  hide(document.getElementById('saveProfileBtn'));

  const avatarBtn = document.getElementById('avatarBtn');
  if(avatarBtn){
    avatarBtn.style.cursor = on ? 'default' : 'pointer';
    avatarBtn.onclick = on ? null : avatarBtn.onclick;
  }
}


function applyLang(lang){
  const t=translations[lang]||translations.en;
  document.documentElement.lang=lang;
  document.body.dataset.lang=lang;
  localStorage.setItem("lang",lang);
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const key=el.getAttribute("data-i18n");
    if(!t[key]) return;
    if(el.tagName==="INPUT"||el.tagName==="TEXTAREA") el.placeholder=t[key]; else el.textContent=t[key];
  });
}

/*  Profile paint  */
function shadeColor(color,percent){
  if(String(color).startsWith("linear-gradient(")) return color;
  let R=parseInt(color.substring(1,3),16),
      G=parseInt(color.substring(3,5),16),
      B=parseInt(color.substring(5,7),16);
  R=Math.min(parseInt((R*(100+percent))/100),255);
  G=Math.min(parseInt((G*(100+percent))/100),255);
  B=Math.min(parseInt((B*(100+percent))/100),255);
  return "#"+[R,G,B].map(v=>v.toString(16).padStart(2,"0")).join("");
}
function applyHeaderBG(bgValue){
  if(!bgValue) return;
  if(String(bgValue).startsWith("linear-gradient(")){
    profileHeader.style.background = bgValue;
  }else{
    profileHeader.style.background=`linear-gradient(180deg,${bgValue},${shadeColor(bgValue,-40)})`;
  }
}
function loadProfile(){
  if(profileData.name) userNameEl.innerText=profileData.name;
  if(profileData.bio) userBioEl.innerText=profileData.bio;
  if(profileData.avatar && !isDefaultAvatar(profileData.avatar)){
  avatarImg.src = profileData.avatar;
  avatarPreview.src = profileData.avatar;
} else {
  avatarImg.src = 'img/user-profile.png';
  avatarPreview.src = 'img/user-profile.png';
}
  if(profileData.bg) applyHeaderBG(profileData.bg);
  updateProfileIcons();
}
function updateProfileIcons(){
  const isDark   = currentTheme() === 'dark';
  const hasUser  = !!auth.currentUser;
  const hasAvatar = !!(profileData && profileData.avatar && !isDefaultAvatar(profileData.avatar));

  const topThumb = document.getElementById('topAvatarImg') || document.getElementById('profileIcon');
  const botThumb = document.getElementById('mbAvatarImg')  || document.getElementById('mbProfileIcon');

  const srcWhenLogged = hasAvatar ? profileData.avatar
    : (isDark ? 'img/user-profile_white.png' : 'img/user-profile.png');

  const srcWhenGuest  = isDark ? 'img/user-profile_white.png' : 'img/user-profile.png';

  const finalTop = hasUser ? srcWhenLogged : srcWhenGuest;
  const finalBot = hasUser ? srcWhenLogged : srcWhenGuest;

  if (topThumb && topThumb.src !== new URL(finalTop, location.href).href) topThumb.src = finalTop;
  if (botThumb && botThumb.src !== new URL(finalBot, location.href).href) botThumb.src = finalBot;
}


function updateAuthUI(){
  const isLogged=!!auth.currentUser;
  if(loginBtn) loginBtn.style.display=isLogged?"none":"block";
  if(logoutBtn) logoutBtn.style.display=isLogged?"block":"none";
  if(switchAccountBtn) switchAccountBtn.style.display=isLogged?"block":"none";
  if(saveProfileBtn) saveProfileBtn.style.display="block";
  if(loginChooser) loginChooser.style.display="none";
  if(loginSection) loginSection.style.display="none";
  updateProfileIcons();
}

/*  Cloud sync  */
async function loadCloud(uid){
  const ref=doc(db,"users",uid);
  const snap=await getDoc(ref);
  if(snap.exists()){
    const data=snap.data()||{};
    profileData = data.profileData || profileData || {};
    animeData   = data.animeData   || animeData   || {watching:[],liked:[],disliked:[]};
    localStorage.setItem("profileData", JSON.stringify(profileData));
    localStorage.setItem("animeData", JSON.stringify(animeData));
  }else{
    await setDoc(ref,{ profileData: profileData||{}, animeData: animeData||{watching:[],liked:[],disliked:[]}, createdAt: Date.now() },{merge:true});
  }
  loadProfile(); renderList();
}
async function saveCloud(uid){
  const ref=doc(db,"users",uid);
  await setDoc(ref,{ profileData, animeData, updatedAt: Date.now() },{merge:true});
}

/*  Public profile loader (by UID from URL)  */
async function loadPublicProfile(uid){
  try{
    const ref  = doc(db, 'users', uid);
    const snap = await getDoc(ref);

    if(!snap.exists()){
      userNameEl.innerText = 'User not found';
      userBioEl.innerText  = '';
      avatarImg.src        = 'img/user-profile.png';
      applyHeaderBG('linear-gradient(135deg,#6c5ce7,#a78bfa)');
      return;
    }

/*  Public lists loader (watching/liked/disliked) by UID  */
async function loadPublicLists(uid){
  try{
    const ref  = doc(db, 'users', uid);
    const snap = await getDoc(ref);
    const data = snap.exists() ? (snap.data()||{}) : {};

    const a = data.animeData || {};
    animeData = {
      watching: Array.isArray(a.watching) ? a.watching : [],
      liked:    Array.isArray(a.liked)    ? a.liked    : [],
      disliked: Array.isArray(a.disliked) ? a.disliked : []
    };

    renderList(); // перерисуем грид
  }catch(e){
    console.warn('loadPublicLists error', e);
    animeData = { watching:[], liked:[], disliked:[] };
    renderList();
  }
}


    const data = snap.data() || {};
    const p    = data.profileData || {};

    const displayName = p.name || p.displayName || 'User';
    const bio         = p.bio || '';
    const avatar      = (p.avatar && !isDefaultAvatar(p.avatar)) ? p.avatar :
                        (currentTheme()==='dark' ? 'img/user-profile_white.png' : 'img/user-profile.png');
    const bg          = p.bg || 'linear-gradient(135deg,#6c5ce7,#a78bfa)';

    userNameEl.innerText = displayName;
    userBioEl.innerText  = bio;
    avatarImg.src        = avatar;
    applyHeaderBG(bg);

    profileData = { name: displayName, bio, avatar, bg }; 
    updateProfileIcons();
  }catch(e){
    console.warn('loadPublicProfile error', e);
    userNameEl.innerText = 'Error';
    userBioEl.innerText  = 'Failed to load profile.';
  }
}


/*  Gradient presets  */
const presets = [
  'linear-gradient(135deg,#6c5ce7,#a78bfa)',
  'linear-gradient(135deg,#22d3ee,#60a5fa)',
  'linear-gradient(135deg,#ef4444,#f59e0b)',
  'linear-gradient(135deg,#10b981,#22d3ee)',
  'linear-gradient(135deg,#fb7185,#c084fc)'
];
const presetWrap = document.getElementById('presetWrap');
presets.forEach((g,i)=>{
  const btn=document.createElement('button');
  btn.className='preset'; btn.type='button'; btn.style.background=g;
  btn.setAttribute('aria-label','Gradient preset '+(i+1));
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.preset.active').forEach(p=>p.classList.remove('active'));
    btn.classList.add('active');
    profileData.bg = g;
    applyHeaderBG(g);
  });
  presetWrap.appendChild(btn);
});

/*  Add modal  */
let addModal=document.createElement("div");
addModal.className="edit-modal";
addModal.id="addModal";
addModal.innerHTML=`
  <div class="edit-box">
    <h3 data-i18n="selectAnime">Select Anime</h3>
    <div id="catalogList" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;max-height:300px;overflow-y:auto;">
      ${Object.keys(SITE_CATALOG).map(name=>`
        <button class="catalog-item" data-name="${name}"
          style="padding:10px;border:none;border-radius:12px;background:var(--accent);
          color:#0b0b0f;cursor:pointer;font-weight:700;">${name}</button>`).join("")}
    </div>
    <div class="edit-actions">
      <button class="closeBtn" id="closeAdd" data-i18n="close">Close</button>
    </div>
  </div>`;
document.body.appendChild(addModal);
document.getElementById("closeAdd").onclick=()=>addModal.classList.remove("active");
addModal.addEventListener("click", async (e)=>{
  if(e.target.classList.contains("catalog-item")){
    const name=e.target.dataset.name;
    if(!animeData[currentTab].includes(name)){
      animeData[currentTab].push(name);
      localStorage.setItem("animeData", JSON.stringify(animeData));
      renderList();
      if(auth.currentUser){ try{ await saveCloud(auth.currentUser.uid); }catch{} }
    }
    addModal.classList.remove("active");
  }
});

/*  Helpers  */
function persistLocal(){ localStorage.setItem("animeData", JSON.stringify(animeData)); }
async function persistAll(){
  persistLocal();
  if(auth?.currentUser){ try{ await saveCloud(auth.currentUser.uid); }catch{} }
}

/*  Actions  */
function doMove(name){
  if(currentTab === 'liked'){
    if(!animeData.disliked.includes(name)) animeData.disliked.push(name);
    const i=animeData.liked.indexOf(name); if(i>-1) animeData.liked.splice(i,1);
  }else if(currentTab === 'disliked'){
    if(!animeData.liked.includes(name)) animeData.liked.push(name);
    const i=animeData.disliked.indexOf(name); if(i>-1) animeData.disliked.splice(i,1);
  }else{ // watching -> liked
    if(!animeData.liked.includes(name)) animeData.liked.push(name);
    const i=animeData.watching.indexOf(name); if(i>-1) animeData.watching.splice(i,1);
  }
}
function doDelete(name){
  const i = (animeData[currentTab]||[]).indexOf(name);
  if(i>-1) animeData[currentTab].splice(i,1);
}

/*  Theme-driven icons in dynamic elements  */
function refreshActionIcons(){
  const set = ICONS[currentTheme()];
  // desktop buttons
  document.querySelectorAll('.desktop-actions .remove img').forEach(img=>img.src=set.remove);
  document.querySelectorAll('.desktop-actions .move img').forEach(img=>img.src=set.move);
  // swipe layer
  document.querySelectorAll('.swipe-layer .left img').forEach(img=>img.src=set.remove);
  document.querySelectorAll('.swipe-layer .right img').forEach(img=>img.src=set.move);
}

/*  Swipe (mobile)  */
function attachSwipe(card, name){
  const content=card.querySelector('a');
  const layer=document.createElement('div');
  layer.className='swipe-layer';
  layer.innerHTML=`
    <span class="icon-pill left"><img src="${ICONS[currentTheme()].remove}" alt="remove"></span>
    <span class="icon-pill right"><img src="${ICONS[currentTheme()].move}" alt="move"></span>`;
  card.appendChild(layer);

  let startX=0, curX=0, dragging=false, clickCanceled=false;
  const threshold = 64, maxSlide  = 120, deadZone=8;

  function setX(x){
    content.style.transform=`translateX(${x}px)`;
    content.style.transition='none';
    if(x>0){ card.classList.add('glow-right'); card.classList.remove('glow-left'); }
    else if(x<0){ card.classList.add('glow-left'); card.classList.remove('glow-right'); }
    else { card.classList.remove('glow-right','glow-left'); }
  }

  function onStart(e){
    if(e.pointerType==='mouse') return; 
    dragging=true; clickCanceled=false;
    startX=e.clientX; curX=0;
    card.classList.add('swiping');
    card.setPointerCapture?.(e.pointerId);
  }
  function onMove(e){
    if(!dragging) return;
    curX=e.clientX-startX;
    if(Math.abs(curX)>deadZone) clickCanceled=true;
    const tx=Math.max(-maxSlide, Math.min(maxSlide, curX));
    setX(tx);
  }
  async function onEnd(e){
    if(!dragging) return;
    dragging=false;
    card.releasePointerCapture?.(e.pointerId);

    if(curX > threshold){ doMove(name); await persistAll(); renderList(); return; }
    if(curX < -threshold){ doDelete(name); await persistAll(); renderList(); return; }

    content.style.transition='transform .18s';
    content.style.transform='translateX(0)';
    card.classList.remove('swiping','glow-left','glow-right');
    setTimeout(()=>{ content.style.transition=''; }, 180);
  }

  content.addEventListener('click', (e)=>{ if(clickCanceled){ e.preventDefault(); e.stopImmediatePropagation(); } });

  card.addEventListener('pointerdown', onStart);
  card.addEventListener('pointermove', onMove);
  card.addEventListener('pointerup', onEnd);
  card.addEventListener('pointercancel', onEnd);
  card.addEventListener('pointerleave', (e)=> dragging && onEnd(e));
}

/*  Desktop card actions  */
function addDesktopActions(card, name){
  const actions = document.createElement('div');
  actions.className='desktop-actions';
  actions.innerHTML = `
    <button class="action-btn remove" title="Remove"><img src="${ICONS[currentTheme()].remove}" alt="remove"></button>
    <button class="action-btn move" title="Move"><img src="${ICONS[currentTheme()].move}" alt="move"></button>
  `;
  card.appendChild(actions);

  const btnRemove = actions.querySelector('.remove');
  const btnMove   = actions.querySelector('.move');

  btnRemove.addEventListener('click', async (e)=>{
    e.preventDefault(); e.stopPropagation();
    doDelete(name); await persistAll(); renderList();
  });
  btnMove.addEventListener('click', async (e)=>{
    e.preventDefault(); e.stopPropagation();
    doMove(name); await persistAll(); renderList();
  });
}

/*  Render list  */
function renderAddCard(){
  if (READ_ONLY_MODE) return;
  const addCard=document.createElement("div");
  addCard.className="big-card";
  addCard.style.cursor="pointer";
  addCard.innerHTML=`
    <a href="#" onclick="return false;">
      <div style="width:100%;height:200px;border:2px dashed var(--line);border-radius:10px;display:flex;align-items:center;justify-content:center;">
        <span style="font-size:80px;color:var(--muted);font-weight:200;line-height:0;">+</span>
      </div>
    </a>`;
  addCard.onclick=()=>addModal.classList.add("active");
  bigGridEl.appendChild(addCard);
}


function renderList(){
  bigGridEl.innerHTML="";
  const list = animeData[currentTab] || [];

  if(list.length===0){
    renderAddCard();
    return;
  }

  list.forEach(name=>{
    const animeInfo = SITE_CATALOG[name];
    if(!animeInfo) return;

    const src  = `img/${animeInfo.file}.jpg`;
    const link = animeInfo.link;

    const card = document.createElement("div");
    card.className = "big-card";
    card.innerHTML = `
      <a href="${link}">
        <img src="${src}" alt="${name}">
      </a>
    `;

    if(!READ_ONLY_MODE){
      // Только на своём профиле: свайпы и иконки действий
      attachSwipe(card, name);
      addDesktopActions(card, name);
    }

    bigGridEl.appendChild(card);
  });

  renderAddCard();
}


/*  Open/close modal & avatar  */
function openEditModal(showLoginChooser=false){
  editModal.classList.add("active");
  document.getElementById("editName").value=userNameEl.innerText||"";
  document.getElementById("editBio").value=userBioEl.innerText||"";
  avatarPreview.src=avatarImg.src;

  document.querySelectorAll('.preset.active').forEach(p=>p.classList.remove('active'));
  if(profileData.bg){
    applyHeaderBG(profileData.bg);
    const idx = presets.findIndex(g=>g===profileData.bg);
    if(idx>-1) presetWrap.children[idx]?.classList.add('active');
    if(!String(profileData.bg).startsWith('linear-gradient(')){
      document.getElementById("bgGradient").value = profileData.bg;
    }
  }
  if(showLoginChooser && !auth.currentUser){
    loginChooser.style.display="flex";
    loginSection.style.display="none";
  }
}
document.getElementById("closeEdit").onclick=()=>editModal.classList.remove("active");
editProfileOpenBtn.addEventListener("click",()=>{ if(!READ_ONLY_MODE) openEditModal(true); });
avatarBtn.addEventListener("click",()=>{ if(!READ_ONLY_MODE) openEditModal(true); });
document.getElementById("changeAvatarBtn").onclick=()=>avatarFile.click();
avatarFile.addEventListener("change",e=>{
  const f=e.target.files[0];
  if(f){ const r=new FileReader(); r.onload=()=> (avatarPreview.src=r.result); r.readAsDataURL(f); }
});
document.getElementById("bgGradient").addEventListener('input',(e)=>{
  document.querySelectorAll('.preset.active').forEach(p=>p.classList.remove('active'));
  profileData.bg = e.target.value;
  applyHeaderBG(profileData.bg);
});

/*  Save profile (local + cloud)  */
document.getElementById("saveProfileBtn").onclick=async ()=>{
  profileData={
    name:document.getElementById("editName").value||"Username",
    bio:document.getElementById("editBio").value||"No bio yet.",
    bg:profileData.bg || document.getElementById("bgGradient").value,
    avatar: isDefaultAvatar(avatarPreview.src) ? null : avatarPreview.src,
  };
  localStorage.setItem("profileData", JSON.stringify(profileData));
  loadProfile();
  updateProfileIcons();
  if(auth.currentUser){ try{ await saveCloud(auth.currentUser.uid); }catch(e){ console.warn("Cloud save err",e); } }
  editModal.classList.remove("active");
  alert("Profile saved!");
};

/*  Login flows  */
if(loginBtn){ loginBtn.onclick=()=> openEditModal(true); }
if(emailBtn){
  emailBtn.onclick=()=>{
    loginChooser.style.display="none";
    loginSection.style.display="block";
    document.getElementById("loginName").value="";
    document.getElementById("loginPass").value="";
  };
}
if(backToChooser){
  backToChooser.onclick=()=>{ loginSection.style.display="none"; loginChooser.style.display="flex"; };
}
if(googleBtn){
  googleBtn.onclick=async ()=>{
    try{ const provider=new GoogleAuthProvider(); await signInWithPopup(auth, provider); }
    catch(e){ alert(e.message); }
  }
}
if(appleBtn){
  appleBtn.onclick=()=>{ alert("Apple Sign-In не подключён. Его можно добавить в Firebase (потребуется Apple Developer)."); };
}
if(doLoginBtn){
  doLoginBtn.onclick=async ()=>{
    const email = document.getElementById("loginName").value.trim();
    const pass  = document.getElementById("loginPass").value.trim();
    if(!email || !pass){ alert("Email and password required."); return; }
    try{
      await signInWithEmailAndPassword(auth, email, pass);
    }catch(err){
      if(err.code==="auth/user-not-found"){
        try{
          const cred = await createUserWithEmailAndPassword(auth, email, pass);
          const displayName = email.split("@")[0];
          await updateProfile(cred.user, { displayName });
        }catch(e){ alert(e.message); return; }
      }else{ alert(err.message); return; }
    }
  };
}

/*  Logout & Switch  */
document.getElementById("logoutBtn").onclick=async ()=>{
  if(confirm("Log out from this device? (Cloud data stays in Firebase)")){
    try{ await signOut(auth); }catch(e){}
    localStorage.removeItem("profileData");
    localStorage.removeItem("animeData");
    location.reload();
  }
};
document.getElementById("switchAccountBtn").onclick=async ()=>{
  if(confirm("Switch account? (Lists are in cloud; this signs you out)")){
    try{ await signOut(auth); }catch(e){}
    sessionStorage.setItem("openEditModal","true");
    location.reload();
  }
};

/*  Tabs  */
const tabs=document.querySelectorAll(".tab-btn");
let currentTab="watching";
tabs.forEach(btn=>{
  btn.onclick=()=>{ tabs.forEach(b=>b.classList.remove("active")); btn.classList.add("active"); currentTab=btn.dataset.tab; renderList(); };
});

/*  Search & Saved  */
document.getElementById("savedBtn")?.addEventListener("click",()=>{ window.location.href="saved.html"; });

function findLinkByQuery(q){
  const query=q.toLowerCase().trim();
  let foundLink=null;
  for(const key in SITE_CATALOG){
    const a=SITE_CATALOG[key];
    const isMatch=Object.values(a.titles).some(tt=>String(tt).toLowerCase().includes(query));
    if(isMatch){ foundLink=a.link; break; }
  }
  return foundLink;
}

document.getElementById("searchBtn")?.addEventListener("click",()=>{
  searchBar.classList.toggle("hidden");
  if(!searchBar.classList.contains("hidden")) searchInput.focus();
});
searchGo?.addEventListener('click', ()=>{
  const link=findLinkByQuery(searchInput.value||'');
  if(link) window.location.href=link; else alert('No anime found.');
});
searchInput?.addEventListener('keydown',(e)=>{
  if(e.key==='Enter'){ const l=findLinkByQuery(searchInput.value||''); if(l) window.location.href=l; else alert('No anime found.'); }
});

/* Mobile search */
mSearchGo?.addEventListener('click', ()=>{
  const link=findLinkByQuery(mSearchInput.value||'');
  if(link) window.location.href=link; else alert('No anime found.');
});
mSearchInput?.addEventListener('keydown', (e)=>{
  if(e.key==='Enter'){ const l=findLinkByQuery(mSearchInput.value||''); if(l) window.location.href=l; else alert('No anime found.'); }
});

/*  Theme/Lang init  */
const savedTheme=localStorage.getItem("theme")||"dark";
const savedLang=localStorage.getItem("lang")||"en";
applyTheme(savedTheme);
applyLang(savedLang);
updateProfileIcons();
if(langSelect) langSelect.value=savedLang;

themeToggleBtn?.addEventListener("click",()=>{
  const cur=document.body.classList.contains("theme-dark")?"dark":"light";
  applyTheme(cur==="dark"?"light":"dark");
});
langSelect?.addEventListener("change",(e)=>applyLang(e.target.value));

/* Mobile bottom bar actions */
mbTheme?.addEventListener('click', ()=>{
  const cur=document.body.classList.contains("theme-dark")?"dark":"light";
  applyTheme(cur==="dark"?"light":"dark");
});
mbLang?.addEventListener('click', ()=>{
  const order=['en','ua','de'];
  const cur=localStorage.getItem('lang')||'en';
  const idx=(order.indexOf(cur)+1)%order.length;
  const next=order[idx];
  if(langSelect) langSelect.value=next;
  applyLang(next);
});
mbSaved?.addEventListener('click', ()=> window.location.href='saved.html');
mbProfile?.addEventListener('click', ()=> window.location.href='profile.html');

/*  Open modal after switch  */
if(sessionStorage.getItem("openEditModal")==="true"){
  openEditModal(true);
  sessionStorage.removeItem("openEditModal");
}

/*  Initial render  */
loadProfile();
renderList();
updateAuthUI();
refreshActionIcons();

/*  Auth state  */
onAuthStateChanged(auth, async (user)=>{
  updateAuthUI();

  const viewUid = getUidFromQuery();
  if(viewUid){
    try{
      await loadPublicProfile(viewUid); 
      await loadPublicLists(viewUid);   
      setReadOnlyProfile(true);        
    }catch(e){
      console.warn(e);
      setReadOnlyProfile(true);
      animeData = { watching:[], liked:[], disliked:[] };
      renderList();
    }
    return; 
  }

  if(user){
    await loadCloud(user.uid);
    if(!profileData.name){
      profileData.name = user.displayName || (user.email ? user.email.split("@")[0] : "User");
      localStorage.setItem("profileData", JSON.stringify(profileData));
      loadProfile();
      try{ await saveCloud(user.uid); }catch{}
    }
    editModal.classList.remove("active");
  }else{
    loadProfile();
    renderList();
  }
});


</script>
</body>
</html>
